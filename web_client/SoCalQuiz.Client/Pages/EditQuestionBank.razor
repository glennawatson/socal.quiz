@page "/addquestionbank/{guildId}"
@page "/editquestionbank/{guildId}/{bankName}"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using SoCal.Quiz.QuestionEditor.Service.DTOs

<PageTitle>Edit Question Bank</PageTitle>

<RadzenBreadCrumb>
    <RadzenBreadCrumbItem Text="Question Banks" Path="/" />
    <RadzenBreadCrumbItem Text=@($"Editing: {_questionBankRequestDto?.Name}") />
</RadzenBreadCrumb>

<RadzenTemplateForm Data="@_questionBankRequestDto" TItem="QuestionBankRequestDto" Submit="HandleValidSubmit">
    <RadzenRow>
        <RadzenColumn>
            <RadzenFieldset Text="Question List">
                <RadzenLabel Text="Bank Name" />
                <RadzenTextBox @bind-Value="_questionBankRequestDto.Name" Style="width: 100%" />
                <RadzenRequiredValidator Component="RadzenTextBox" Text="Bank Name is required" />

                <RadzenDataGrid Data="@_questionBankRequestDto.Questions" TItem="QuestionRequestDto" SelectionMode="DataGridSelectionMode.Single" RowSelect="@(x => _selectedQuestion = x)">
                    <Columns>
                        <RadzenDataGridColumn TItem="QuestionRequestDto" Property="Question" Title="Question" />
                        <RadzenDataGridColumn TItem="QuestionRequestDto" Property="Explanation" Title="Explanation" />
                        <RadzenDataGridColumn TItem="QuestionRequestDto" Context="question" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                            <Template Context="question">
                                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(args => DeleteQuestion(question))" @onclick:stopPropagation="true">
                                </RadzenButton>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenFieldset>
        </RadzenColumn>
    </RadzenRow>
    @if (_selectedQuestion is not null)
    {
        <RadzenRow>
            <RadzenColumn>
                <RadzenFieldset Text="Edit Question">
                    <RadzenLabel Text="Question Text" />
                    <RadzenTextBox @bind-Value="_selectedQuestion.Question" Style="width: 100%" />
                    <RadzenRequiredValidator Component="RadzenTextBox" Text="Question Text is required" />

                    <RadzenDataGrid Data="@_selectedQuestion.Answers" TItem="AnswerDto" RowSelect="@(x => _selectedAnswer = x)">
                        <Columns>
                            <RadzenDataGridColumn TItem="AnswerDto" Property="Answer" Title="Answer" />
                            <RadzenDataGridColumn TItem="AnswerDto" Context="answer" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                                <Template Context="answer">
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(args => DeleteAnswer(answer))" @onclick:stopPropagation="true">
                                    </RadzenButton>
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>

                    <RadzenLabel Text="Correct Answer ID" />
                    <RadzenTextBox @bind-Value="_selectedQuestion.CorrectAnswerId" Style="width: 100%" />
                    <RadzenRequiredValidator Component="RadzenTextBox" Text="Correct Answer ID is required" />

                    <RadzenLabel Text="Image URL" />
                    <RadzenTextBox @bind-Value="_selectedQuestion.ImageUrl" Style="width: 100%" />
                    <RadzenRequiredValidator Component="RadzenTextBox" Text="Image URL is required" />
                    @if (!string.IsNullOrWhiteSpace(_selectedQuestion.ImageUrl))
                    {
                        <RadzenImage Path="@_selectedQuestion.ImageUrl" Style="width: 100%; margin-top: 10px;" />
                    }

                    <RadzenLabel Text="Explanation" />
                    <RadzenHtmlEditor @bind-Value="_selectedQuestion.Explanation" Style="width: 100%" />

                    <RadzenLabel Text="Explanation Image URL" />
                    <RadzenTextBox @bind-Value="_selectedQuestion.ExplanationImageUrl" Style="width: 100%" />
                    <RadzenRequiredValidator Component="RadzenTextBox" Text="Explanation Image URL is required" />
                    @if (!string.IsNullOrWhiteSpace(_selectedQuestion.ExplanationImageUrl))
                    {
                        <RadzenImage Path="@_selectedQuestion.ExplanationImageUrl" Style="width: 100%; margin-top: 10px;" />
                    }

                    <RadzenLabel Text="Show Time (ms)" />
                    <RadzenNumeric @bind-Value="_selectedQuestion.QuestionShowTimeMs" Style="width: 100%" />
                </RadzenFieldset>

            </RadzenColumn>
        </RadzenRow>
    }

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem" Class="rz-mt-8 rz-mb-4">
        <RadzenButton ButtonType="ButtonType.Submit" Size="ButtonSize.Large" Icon="save" Text="Save" />
        <RadzenButton ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Large" Icon="cancel" Text="Cancel" Click="@Cancel" />
    </RadzenStack>

</RadzenTemplateForm>
